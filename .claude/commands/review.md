---
description: 代码审查 — 质量把关、漏洞发现 (Codex 5.2)
argument-hint: [范围或文件]
---

# 代码审查阶段 (2025 Optimized)

**主控**: Codex 5.2 (修复审查)

## 任务

$ARGUMENTS

## 执行流程

遵循项目规则和治理：
- 读取并遵循：.council/AGENTS.md 和 .council/CLAUDE.md
- 参考：.council/NOTES.md (已记录的决策和风险)

### 1. 确定审查范围

**自动检测**：
```bash
# 审查未提交的修改
git diff

# 审查最近一次提交
git diff HEAD~1

# 审查指定文件
审查范围：$ARGUMENTS
```

**如果 $ARGUMENTS 为空**：
- 默认审查 `git diff` 的所有修改
- 如果没有修改，审查最近一次提交

### 2. 质量审查维度

**委托给 Codex**：

```bash
codex "审查以下代码，输出风险点 + 精确位置 + 修复建议：

审查维度：
1. 代码质量
   - [ ] 是否遵循项目规范 (CLAUDE.md)
   - [ ] 是否有明显的代码异味
   - [ ] 是否过度工程化

2. 安全性
   - [ ] SQL 注入风险
   - [ ] XSS 跨站脚本
   - [ ] 命令注入
   - [ ] 敏感信息泄露 (硬编码密钥)
   - [ ] OWASP Top 10 漏洞

3. 边界对齐
   - [ ] API 契约是否变化
   - [ ] 错误处理是否完整
   - [ ] 边界条件是否覆盖
   - [ ] 向后兼容性

4. 性能风险
   - [ ] N+1 查询
   - [ ] 内存泄漏风险
   - [ ] 阻塞操作未异步化

5. 测试覆盖
   - [ ] 是否有对应测试
   - [ ] 覆盖率是否 ≥ 90%
   - [ ] 边界测试是否充分

审查范围：
<git diff 或指定文件内容>
"
```

### 3. 输出审查报告

**格式要求**：

```markdown
## 代码审查报告

### 审查范围
- 文件数：X
- 修改行数：+X -Y
- 复杂度：简单/中等/复杂

### 风险点 (按严重性排序)

#### 🔴 高风险 (必须修复)
1. **[文件:行号] 风险描述**
   - 问题：具体问题说明
   - 影响：可能导致的后果
   - 修复建议：具体修复方案

#### 🟡 中风险 (建议修复)
1. **[文件:行号] 风险描述**
   - 问题：...
   - 修复建议：...

#### 🟢 低风险 (可选优化)
1. **[文件:行号] 优化建议**
   - 当前实现：...
   - 优化方向：...

### 边界对齐检查
- [ ] API 契约未变化
- [ ] 向后兼容
- [ ] 错误处理完整

### 测试覆盖
- [ ] 单元测试覆盖 ≥ 90%
- [ ] 边界测试充分
- [ ] 集成测试（如需）

### 总体评价
✅ 通过 / ⚠️ 条件通过 / ❌ 不通过

### 后续行动
- [ ] 立即修复：高风险项
- [ ] 计划修复：中风险项
- [ ] 技术债记录：低风险项
```

### 4. 更新 NOTES.md

**操作**：
```bash
# 将审查结果追加到 .council/NOTES.md
# 记录关键决策和风险点
```

## 委托命令

实际执行时，通过 Codex 完成审查：

```bash
# 方式 1: 直接调用 Codex (推荐)
codex "代码审查: $ARGUMENTS. 输出风险点+位置+修复建议."

# 方式 2: 通过 delegate (备用)
/delegate codex "审查: $ARGUMENTS"
```

## 输出要求

1. **风险点列表**（严重性分级 + 精确位置）
2. **修复建议**（具体可执行的方案）
3. **边界对齐检查结果**
4. **总体评价**（通过/条件通过/不通过）
5. **更新 `.council/NOTES.md`**（记录审查结果）

## 触发时机

**在以下情况后执行 `/review`**：
- `/verify` 通过后
- 准备提交 (commit) 前
- PR 合并前
- 重大重构后

## 示例

**输入**：
```bash
/review
# 或
/review "src/telegram_multi/message_interceptor.py"
```

**输出**：
```markdown
## 代码审查报告

### 审查范围
- 文件数：2
- 修改行数：+45 -3
- 复杂度：中等

### 风险点

#### 🟡 中风险
1. **[message_interceptor.py:288] 翻译失败时静默忽略**
   - 问题：`except Exception: pass` 捕获所有异常但未记录
   - 影响：调试困难，用户不知道翻译失败原因
   - 修复建议：至少记录到 console.warn 或日志

### 边界对齐检查
- [x] API 契约未变化
- [x] 向后兼容
- [x] 错误处理完整

### 测试覆盖
- [x] 单元测试覆盖 96%
- [x] 边界测试充分

### 总体评价
⚠️ 条件通过 (修复中风险项后可合并)

### 后续行动
- [ ] 建议修复：message_interceptor.py 异常处理
```

## 审查通过标准

**必须满足**：
- ✅ 无高风险项
- ✅ 边界对齐检查全部通过
- ✅ 测试覆盖率 ≥ 90%
- ✅ `just verify` 已通过

**可选满足**：
- 中风险项已记录到技术债
- 低风险项已评估影响
