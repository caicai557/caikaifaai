# 六步自愈循环 SOP 详细流程

> 遵循 Dev Workflow 标准操作程序，通过 CLI 优势互补实现高效产出

## 流程图

```text
用户需求
    │
    ▼
┌──────────────────┐
│ 1. PM (Codex)    │ ← 逻辑拆解、PRD、任务树
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. 架构 (Gemini) │ ← 2M 长上下文、全库审计
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. QA (Claude)   │ ← TDD 先行、覆盖率 ≥ 90%
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. 执行 (Claude) │ ← Code Mode、批量脚本
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌───────────┐
│ 5. 裁决 (verify) │────▶│ 自愈循环  │
└────────┬─────────┘     └─────┬─────┘
         │                     │
         │◀────────────────────┘
         ▼
┌──────────────────┐
│ 6. 总结 (Gemini) │ ← NOTES、/rewind、/clear
└──────────────────┘
```

## 阶段详解

### 1. 需求代码化 (PM)

**主控**: Codex (GPT-5.2)

```markdown
输入: "帮我优化登录功能"
输出:
  - PRD: 问题/用户/非目标
  - 任务树: 5 个小步骤
  - 验收标准: 可测试条件
```

### 2. 全库审计 (架构师)

**主控**: Gemini 3 Pro

```markdown
能力: 2M tokens 上下文
动作:
  - 扫描整个代码库
  - 发现新旧逻辑冲突
  - 输出技术设计文档
```

### 3. TDD 强制约束 (QA)

**主控**: Claude Code

```markdown
规则: 测试覆盖率 < 90% 禁止执行
动作:
  - 根据设计文档写测试
  - 红灯验证 (测试应失败)
```

### 4. 程序化并行执行

**主控**: Claude Code (Code Mode)

**Token 节省核心**:

```python
# 编写 Python 脚本批量操作，而非逐条自然语言指令
# Token 节省约 98.7%

import subprocess
files_to_modify = [...]
for f in files_to_modify:
    # 批量修改
    pass
```

### 5. 自愈校验

**命令**: `just verify`

**自愈循环**:

```text
运行测试 → 失败 → 提取错误日志 → 修复 → 重试
    ▲                                    │
    └────────────────────────────────────┘
```

**Wald 共识**:

- π 达置信上限 → 自动提交
- 分歧过大 → 人在回路审计

### 6. 总结与快照

**主控**: Gemini

```bash
# 1. 建立快照
/rewind

# 2. 更新笔记
echo "Session summary..." >> NOTES.md

# 3. 重置会话
/clear
```

## 命令速查

```bash
# PM 阶段
codex "将需求转化为 PRD"

# 审计阶段
gemini "审计全库，输出设计文档"

# TDD 阶段
claude "先写测试，覆盖率 ≥ 90%"

# 执行阶段
claude --code-mode "批量执行修改脚本"

# 裁决阶段
just verify

# 总结阶段
gemini "总结会话，更新 NOTES"
```
