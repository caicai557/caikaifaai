"""
Council Workflow Commands - å…­æ­¥å·¥ä½œæµCLIå‘½ä»¤

ç»Ÿä¸€ç®€æ´çš„å‘½ä»¤æ¥å£:
- council init      ç”Ÿæˆ CLAUDE.md
- council plan      åªè¯»è®¡åˆ’æ¨¡å¼  
- council audit     å…¨åº“å®¡è®¡
- council tdd       TDDæµ‹è¯•ç”Ÿæˆ
- council execute   æ²™ç›’æ‰§è¡Œ
- council rewind    å¿«ç…§å¤‡ä»½
- council clear     ä¼šè¯æ¸…ç†
"""

import os
from pathlib import Path
from datetime import datetime
from typing import Optional

from council.agents.base_agent import ModelConfig


def init_command(output_path: str = "CLAUDE.md") -> str:
    """
    /init - è‡ªåŠ¨æ‰«æç”Ÿæˆ CLAUDE.md
    
    Args:
        output_path: è¾“å‡ºæ–‡ä»¶è·¯å¾„
        
    Returns:
        ç”Ÿæˆçš„å†…å®¹
    """
    from council.workflow.audit_phase import FullRepoScanner
    
    scanner = FullRepoScanner()
    scan_result = scanner.scan()
    
    content = f"""# CLAUDE.md - é¡¹ç›®è§„èŒƒ (è‡ªåŠ¨ç”Ÿæˆ)

> **Strictly follow the rules in ./AGENTS.md**
> **Generated at**: {datetime.now().strftime("%Y-%m-%d %H:%M")}

## é¡¹ç›®æ¦‚è§ˆ

- **æ–‡ä»¶æ€»æ•°**: {scan_result.get("total_files", 0)}
- **æ‰«ææ—¶é—´**: {scan_result.get("scanned_at", "")}

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ |
|------|------|
| **è¯­è¨€** | Python 3.12+ |
| **ç±»å‹** | Pydantic v2 |
| **æµ‹è¯•** | pytest |
| **Lint** | ruff |

## æ„å»ºå‘½ä»¤

```bash
pytest tests/ -v
ruff check .
```

## æ¨¡å‹é…ç½®

| Agent | æ¨¡å‹ |
|-------|------|
| Orchestrator | {ModelConfig.CLAUDE_OPUS} |
| Coder | {ModelConfig.GEMINI_FLASH} |
| Auditor | {ModelConfig.CODEX} |

---
**Auto-generated by Council CLI**
"""
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(content)
    
    print(f"âœ… Generated {output_path}")
    return content


def plan_command(task: str) -> dict:
    """
    /plan - åªè¯»è®¡åˆ’æ¨¡å¼
    
    Args:
        task: ä»»åŠ¡æè¿°
        
    Returns:
        è®¡åˆ’ç»“æœ
    """
    from council.workflow.pm_phase import RequirementParser, TaskTreeGenerator
    
    parser = RequirementParser()
    generator = TaskTreeGenerator()
    
    requirement = parser.parse(task)
    task_tree = generator.generate(requirement)
    
    print("ğŸ“‹ ä»»åŠ¡è®¡åˆ’:")
    for node in task_tree:
        print(f"  - [{node.id}] {node.title} ({node.assigned_agent})")
    
    return {
        "requirement": requirement,
        "task_tree": [{"id": n.id, "title": n.title} for n in task_tree],
    }


def audit_command(target_dir: str = ".") -> dict:
    """
    /audit - å…¨åº“å®¡è®¡ (Gemini Pro)
    
    Args:
        target_dir: ç›®æ ‡ç›®å½•
        
    Returns:
        å®¡è®¡ç»“æœ
    """
    from council.workflow.audit_phase import FullRepoScanner
    
    print(f"ğŸ” æ­£åœ¨æ‰«æ {target_dir} (ä½¿ç”¨ {ModelConfig.GEMINI_PRO})...")
    
    scanner = FullRepoScanner(root_dir=target_dir)
    result = scanner.scan()
    
    print(f"âœ… æ‰«æå®Œæˆ: {result.get('total_files', 0)} ä¸ªæ–‡ä»¶")
    
    return result


def tdd_command(feature: str) -> dict:
    """
    /tdd - TDDæµ‹è¯•ç”Ÿæˆ (Claude Sonnet)
    
    Args:
        feature: åŠŸèƒ½æè¿°
        
    Returns:
        ç”Ÿæˆçš„æµ‹è¯•
    """
    from council.workflow.tdd_phase import TestGenerator
    
    print(f"ğŸ§ª æ­£åœ¨ç”Ÿæˆæµ‹è¯• (ä½¿ç”¨ {ModelConfig.CLAUDE_SONNET})...")
    
    generator = TestGenerator()
    tests = generator.generate(feature)
    
    print(f"âœ… ç”Ÿæˆ {len(tests)} ä¸ªæµ‹è¯•ç”¨ä¾‹:")
    for test in tests:
        print(f"  - {test.name}")
    
    return {"tests": [{"id": t.id, "name": t.name} for t in tests]}


def execute_command(task: str, sandbox: str = "docker") -> dict:
    """
    /execute - æ²™ç›’æ‰§è¡Œ
    
    Args:
        task: ä»»åŠ¡æè¿°
        sandbox: æ²™ç›’ç±»å‹ (docker, local)
        
    Returns:
        æ‰§è¡Œç»“æœ
    """
    from council.workflow.executor_phase import PTCExecutor
    
    print(f"ğŸš€ æ­£åœ¨æ‰§è¡Œ (æ²™ç›’: {sandbox})...")
    
    executor = PTCExecutor(sandbox_type=sandbox)
    result = executor.execute(task, {})
    
    print(f"{'âœ…' if result.success else 'âŒ'} {result.output_summary}")
    print(f"   Token èŠ‚çœ: {result.token_saved:.1%}")
    
    return {
        "success": result.success,
        "summary": result.output_summary,
        "token_saved": result.token_saved,
    }


def rewind_command(snapshot_id: Optional[str] = None) -> str:
    """
    /rewind - å¿«ç…§å¤‡ä»½
    
    Args:
        snapshot_id: å¿«ç…§ID (é»˜è®¤è‡ªåŠ¨ç”Ÿæˆ)
        
    Returns:
        å¿«ç…§æ–‡ä»¶è·¯å¾„
    """
    from council.workflow.persistence import SessionSnapshot
    
    sid = snapshot_id or f"snap_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    snapshot = SessionSnapshot(
        snapshot_id=sid,
        task_summary="æ‰‹åŠ¨å¿«ç…§",
        files_modified=[],
        context={},
    )
    
    filepath = snapshot.save()
    print(f"ğŸ“¸ å¿«ç…§å·²ä¿å­˜: {filepath}")
    
    return filepath


def clear_command(keep: int = 5) -> dict:
    """
    /clear - ä¼šè¯æ¸…ç†
    
    Args:
        keep: ä¿ç•™å¿«ç…§æ•°é‡
        
    Returns:
        æ¸…ç†ç»“æœ
    """
    from council.workflow.persistence import ContextCleaner
    
    cleaner = ContextCleaner()
    result = cleaner.clear(keep_snapshots=keep)
    
    print(f"ğŸ§¹ å·²æ¸…ç† {result['deleted']} ä¸ªå¿«ç…§, ä¿ç•™ {result['kept']} ä¸ª")
    
    return result


__all__ = [
    "init_command",
    "plan_command", 
    "audit_command",
    "tdd_command",
    "execute_command",
    "rewind_command",
    "clear_command",
]
