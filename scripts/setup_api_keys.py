#!/usr/bin/env python3
"""
Council API Keys é…ç½®å‘å¯¼

äº¤äº’å¼è®¾ç½® Anthropicã€OpenAIã€Google API keys
"""

import os
import sys
from pathlib import Path


def setup_env_file():
    """åˆ›å»ºæˆ–æ›´æ–° .env æ–‡ä»¶"""
    env_path = Path(__file__).parent.parent / ".env"

    existing_keys = {}
    if env_path.exists():
        with open(env_path) as f:
            for line in f:
                line = line.strip()
                if "=" in line and not line.startswith("#"):
                    key, value = line.split("=", 1)
                    existing_keys[key] = value

    print("\n" + "=" * 60)
    print("  Council API Keys é…ç½®å‘å¯¼")
    print("=" * 60)
    print("\næŒ‰ Enter è·³è¿‡å·²è®¾ç½®çš„ keyï¼Œè¾“å…¥æ–°å€¼è¦†ç›–\n")

    keys_to_set = [
        ("ANTHROPIC_API_KEY", "Anthropic (Claude)", "sk-ant-..."),
        ("OPENAI_API_KEY", "OpenAI (GPT)", "sk-..."),
        ("GEMINI_API_KEY", "Google Gemini", "AI..."),
    ]

    new_keys = {}
    for key, name, example in keys_to_set:
        current = existing_keys.get(key, os.environ.get(key, ""))
        if current:
            masked = current[:8] + "..." + current[-4:] if len(current) > 12 else "***"
            prompt = f"{name} [{masked}]: "
        else:
            prompt = f"{name} (ä¾‹: {example}): "

        value = input(prompt).strip()
        if value:
            new_keys[key] = value
        elif current:
            new_keys[key] = current

    # å†™å…¥ .env æ–‡ä»¶
    if new_keys:
        with open(env_path, "w") as f:
            f.write("# Council API Keys\n")
            f.write("# Auto-generated by setup_api_keys.py\n\n")
            for key, value in new_keys.items():
                f.write(f"{key}={value}\n")

        print(f"\nâœ… å·²ä¿å­˜åˆ° {env_path}")
        print("\nè¦åŠ è½½è¿™äº› keysï¼Œè¿è¡Œ:")
        print(f"  source {env_path}")
        print("  # æˆ–")
        print("  export $(cat .env | xargs)")
    else:
        print("\nâš ï¸ æœªè®¾ç½®ä»»ä½• API key")

    return new_keys


def check_gcloud():
    """æ£€æŸ¥å¹¶æç¤ºå®‰è£… gcloud"""
    import shutil

    if shutil.which("gcloud"):
        print("\nâœ… gcloud CLI å·²å®‰è£…")
        print("è¿è¡Œä»¥ä¸‹å‘½ä»¤ç™»å½• Google Cloud:")
        print("  gcloud auth application-default login")
        return True
    else:
        print("\nâš ï¸ gcloud CLI æœªå®‰è£…")
        print("å®‰è£…æ–¹æ³•:")
        print("  # Ubuntu/Debian")
        print("  sudo apt-get install google-cloud-cli")
        print("  # æˆ–ä¸‹è½½: https://cloud.google.com/sdk/docs/install")
        return False


def main():
    print("\nğŸ”‘ Council å¤šæ¨¡å‹ API é…ç½®\n")

    # 1. è®¾ç½® API keys
    keys = setup_env_file()

    # 2. æ£€æŸ¥ gcloud
    print("\n" + "-" * 40)
    check_gcloud()

    # 3. éªŒè¯
    print("\n" + "-" * 40)
    print("\néªŒè¯é…ç½®:")

    for key in ["ANTHROPIC_API_KEY", "OPENAI_API_KEY", "GEMINI_API_KEY"]:
        value = keys.get(key) or os.environ.get(key)
        status = "âœ…" if value else "âŒ"
        print(f"  {status} {key}")

    print("\nå®Œæˆ! ç°åœ¨å¯ä»¥è¿è¡Œ:")
    print("  python -m council.cli dev 'ä½ çš„ä»»åŠ¡'")


if __name__ == "__main__":
    main()
